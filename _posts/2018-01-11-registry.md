---
layout: post
tags : [docker, linux]
title: 容器镜像仓库笔记

---

## 镜像层

Docker v1.10 之前

* image ID是随机生成的，与内容无关。这一方面很容易导致image ID被伪造，也容易引发冲突

* image与layer没有严格的区别

在v1.10 之后:

* image与layer是严格区分的。image ID与layer ID是两个不同的对象，生成的算法也不一样，但都是根据内容(content-addressable)生成的

镜像层在客户端和distribution端的不同:

* 客户端: 存储?  使用`hashes of uncompressed data`

* distribution: 存储的layer是压缩文件, 使用 `hashes of compressed data`

  但是，每个push生成的distribution hashes可能会不一样，因为同一个tar文件，每次压缩生成的文件可能会有区别 ??

---

## Distribution 存储分析

#### 标识:

* IMAGE ID: 本地由Docker根据镜像的描述文件计算的，并用于imagedb的目录名称 `SHA256hex(imageConfigJSON)`
* Tag Digest: 同 Docker-Content-Digest 有registry端根据manifest计算而来
* Layer Digest: Distribution根据layer compressed data计算的，并用于Distribution的存储目录名称
* Manifest Digest: 同 Docker-Content-Digest
* layer.DiffID: 本地由Docker根据layer uncompressed data计算的`DiffID = SHA256hex(uncompressed layer tar data)`。layer.ChainID只用本地，根据layer.DiffID计算，并用于layerdb的目录名称, 本地inspect 后通过 RootFS.Layers可以看到
* layer.ChainID: TODO
* layer.cacheID: TODO


#### 客户端拉取镜像:

```
docker pull localhost:5000/my-ubuntu
Using default tag: latest
latest: Pulling from my-ubuntu
50aff78429b1: Pull complete 这些都是镜像层digest
f6d82e297bce: Pull complete
275abb2c8a6f: Pull complete
9f15a39356d6: Pull complete
fc0342a94c89: Pull complete
Digest: sha256:f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663 这是tag digest
Status: Downloaded newer image for localhost:5000/my-ubuntu:latest
```

#### 客户端查看镜像:

```
% docker images localhost:5000/my-ubuntu --digests
REPOSITORY                 TAG                 DIGEST(这是Tag Digest)                                                    IMAGE ID            CREATED             SIZE
localhost:5000/my-ubuntu   latest              sha256:f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663   00fd29ccc6f1        3 weeks ago         111MB
```

#### distribution的存储结构:

* blobs: 存储实际的layer数据
* repositories: 存储image/tag相关的信息

```
├── blobs
│   └── sha256
│       ├── 00
│       │   └── 00fd29ccc6f167fa991580690a00e844664cb2381c74cd14d539e36ca014f043 [IMAGE ID]
│       │       └── data json 文件, image的具体信息
│       ├── 27
│       │   └── 275abb2c8a6f1ce8e67a388a11f3cc014e98b36ff993a6ed1cc7cd6ecb4dd61b
│       │       └── data 二进制层
│       ├── 50
│       │   └── 50aff78429b146489e8a6cb9334d93a6d81d5de2edc4fbf5e2d4d9253625753e
│       │       └── data 二进制层
│       ├── 9f
│       │   └── 9f15a39356d6fc1df0a77012bf1aa2150b683e46be39d1c51bc7a320f913e322
│       │       └── data 二进制层
│       ├── f6
│       │   └── f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f
│       │       └── data 二进制层
│       ├── f8
│       │   └── f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663 [Tag Digest] 指向manifest
│       │       └── data  这个tag digest下的data是一个json文件, 包括层关系, 见下
│       └── fc
│           └── fc0342a94c89e477c821328ccb542e6fb86ce4ef4ebbf1098e85669e051ef0dd
│               └── data 二进制层
└── repositories
    └── my-ubuntu  镜像仓库名
        ├── _layers
        │   └── sha256 以下是各layers的digest, 也包括image digest(客户端的IMAGE ID)
        │       ├── 00fd29ccc6f167fa991580690a00e844664cb2381c74cd14d539e36ca014f043 [IMAGE ID]
        │       │   └── link 内容sha256:加上上面ID
        │       ├── 275abb2c8a6f1ce8e67a388a11f3cc014e98b36ff993a6ed1cc7cd6ecb4dd61b
        │       │   └── link 内容sha256:加上上面ID
        │       ├── 50aff78429b146489e8a6cb9334d93a6d81d5de2edc4fbf5e2d4d9253625753e
        │       │   └── link 内容sha256:加上上面ID
        │       ├── 9f15a39356d6fc1df0a77012bf1aa2150b683e46be39d1c51bc7a320f913e322
        │       │   └── link 内容sha256:加上上面ID
        │       ├── f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f
        │       │   └── link 内容sha256:加上上面ID
        │       └── fc0342a94c89e477c821328ccb542e6fb86ce4ef4ebbf1098e85669e051ef0dd
        │           └── link 内容sha256:加上上面ID
        ├── _manifests
        │   ├── revisions
        │   │   └── sha256
        │   │       └── f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663 [Tag Digest]
        │   │           └── link 内容sha256:加上上面ID
        │   └── tags 该镜像仓库下的各个tag的信息
        │       └── latest
        │           ├── current
        │           │   └── link 内容sha256:f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663
        │           └── index
        │               └── sha256
        │                   └── f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663 [Tag Digest]
        │                       └── link 内容sha256:f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663
        └── _uploads
```

查看镜像层关系文件(tag->image+layers)`cat blobs/sha256/f8/f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663/data`

```
{
   "schemaVersion": 2,
   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
   "config": {
      "mediaType": "application/vnd.docker.container.image.v1+json",
      "size": 3615,
      "digest": "sha256:00fd29ccc6f167fa991580690a00e844664cb2381c74cd14d539e36ca014f043" [IMAGE ID]
   },
   "layers": [ 以下是镜像层信息
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 42743207,
         "digest": "sha256:50aff78429b146489e8a6cb9334d93a6d81d5de2edc4fbf5e2d4d9253625753e"
      },
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 846,
         "digest": "sha256:f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f"
      },
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 621,
         "digest": "sha256:275abb2c8a6f1ce8e67a388a11f3cc014e98b36ff993a6ed1cc7cd6ecb4dd61b"
      },
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 854,
         "digest": "sha256:9f15a39356d6fc1df0a77012bf1aa2150b683e46be39d1c51bc7a320f913e322"
      },
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 170,
         "digest": "sha256:fc0342a94c89e477c821328ccb542e6fb86ce4ef4ebbf1098e85669e051ef0dd"
      }
   ]
}
```

查看镜像文件信息: `cat blobs/sha256/00/00fd29ccc6f167fa991580690a00e844664cb2381c74cd14d539e36ca014f043/data`

```
{"architecture":"amd64","config":{"Hostname":"","Domainname":"","User":"","AttachStdin":false,"AttachStdout":false,"AttachStderr":false,"Tty":false,"OpenStdin":false,"StdinOnce":false,"Env":["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],"Cmd":["/bin/bash"],"ArgsEscaped":true,"Image":"sha256:34474a3a3cc6e7214fac71230369eb5178b5645acd8db7755c030037099b536a","Volumes":null,"WorkingDir":"","Entrypoint":null,"OnBuild":null,"Labels":null},"container":"d512da9df07b186ea9bbad0424b1111fef17c10836ce9c5fdbf252544508803b","container_config":{"Hostname":"d512da9df07b","Domainname":"","User":"","AttachStdin":false,"AttachStdout":false,"AttachStderr":false,"Tty":false,"OpenStdin":false,"StdinOnce":false,"Env":["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],"Cmd":["/bin/sh","-c","#(nop) ","CMD [\"/bin/bash\"]"],"ArgsEscaped":true,"Image":"sha256:34474a3a3cc6e7214fac71230369eb5178b5645acd8db7755c030037099b536a","Volumes":null,"WorkingDir":"","Entrypoint":null,"OnBuild":null,"Labels":{}},"created":"2017-12-14T20:59:48.244728969Z","docker_version":"17.06.2-ce","history":[{"created":"2017-12-14T20:59:45.307546564Z","created_by":"/bin/sh -c #(nop) ADD file:f5a2d04c3f3cafada15eb32e4e8d971e48ef11724939c399a8664bf498111e67 in / "},{"created":"2017-12-14T20:59:46.089739785Z","created_by":"/bin/sh -c set -xe \t\t\u0026\u0026 echo '#!/bin/sh' \u003e /usr/sbin/policy-rc.d \t\u0026\u0026 echo 'exit 101' \u003e\u003e /usr/sbin/policy-rc.d \t\u0026\u0026 chmod +x /usr/sbin/policy-rc.d \t\t\u0026\u0026 dpkg-divert --local --rename --add /sbin/initctl \t\u0026\u0026 cp -a /usr/sbin/policy-rc.d /sbin/initctl \t\u0026\u0026 sed -i 's/^exit.*/exit 0/' /sbin/initctl \t\t\u0026\u0026 echo 'force-unsafe-io' \u003e /etc/dpkg/dpkg.cfg.d/docker-apt-speedup \t\t\u0026\u0026 echo 'DPkg::Post-Invoke { \"rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\"; };' \u003e /etc/apt/apt.conf.d/docker-clean \t\u0026\u0026 echo 'APT::Update::Post-Invoke { \"rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\"; };' \u003e\u003e /etc/apt/apt.conf.d/docker-clean \t\u0026\u0026 echo 'Dir::Cache::pkgcache \"\"; Dir::Cache::srcpkgcache \"\";' \u003e\u003e /etc/apt/apt.conf.d/docker-clean \t\t\u0026\u0026 echo 'Acquire::Languages \"none\";' \u003e /etc/apt/apt.conf.d/docker-no-languages \t\t\u0026\u0026 echo 'Acquire::GzipIndexes \"true\"; Acquire::CompressionTypes::Order:: \"gz\";' \u003e /etc/apt/apt.conf.d/docker-gzip-indexes \t\t\u0026\u0026 echo 'Apt::AutoRemove::SuggestsImportant \"false\";' \u003e /etc/apt/apt.conf.d/docker-autoremove-suggests"},{"created":"2017-12-14T20:59:46.735863349Z","created_by":"/bin/sh -c rm -rf /var/lib/apt/lists/*"},{"created":"2017-12-14T20:59:47.411048575Z","created_by":"/bin/sh -c sed -i 's/^#\\s*\\(deb.*universe\\)$/\\1/g' /etc/apt/sources.list"},{"created":"2017-12-14T20:59:48.062144391Z","created_by":"/bin/sh -c mkdir -p /run/systemd \u0026\u0026 echo 'docker' \u003e /run/systemd/container"},{"created":"2017-12-14T20:59:48.244728969Z","created_by":"/bin/sh -c #(nop)  CMD [\"/bin/bash\"]","empty_layer":true}],"os":"linux","rootfs":{"type":"layers","diff_ids":["sha256:48e0baf45d4dfd028eab0a7d444309b436cac01ae879805ac0cfdf5aaf1ff93a","sha256:d2f8c05d353b2d55e191eccba65b72d72fd230c6fbef9cac97d5be5499bcd939","sha256:5a876f8f1a3d04b1f9735e38e5111e6f11cbf6cad2a44dc3ca6d394dd93caa5f","sha256:6458f770d435ace5bfba5b99460059c08e7dba66e8606e70ecf941dc1f705077","sha256:f17fc24fb8d0efef646c75c2977fd41e6816922322944fa3683eeac3aaeec80f"]}}
```

#### manifest文件

获取tag的manifest文件: `http://127.0.0.1:5000/v2/my-ubuntu/manifests/latest`

`Docker-Content-Digest: sha256:d64cc6858a7bc61cc44b00b6d2b3a11859dbd683da0066d77f5b2b85cc157f7c` 这个是manifest文件的 digest

Existing Manifests

`curl -I -X HEAD http://127.0.0.1:5000/v2/my-ubuntu/manifests/latest`

同样返回manifest文件的 digest

```
HTTP/1.1 200 OK
Content-Length: 6049
Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws
Docker-Content-Digest: sha256:d64cc6858a7bc61cc44b00b6d2b3a11859dbd683da0066d77f5b2b85cc157f7c
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:d64cc6858a7bc61cc44b00b6d2b3a11859dbd683da0066d77f5b2b85cc157f7c"
```

---

## Distribution 交互

### Pulling an Image Manifest

`GET /v2/<name>/manifests/<reference>`

reference 是tag name, 或者tag digest(需要加上 sha256:)

如 `http://127.0.0.1:5000/v2/my-ubuntu/manifests/sha256:f871d0805ee3ce1c52b0608108dbdf1b447a34d22d5c7278a3a9dd78fc12c663`

* Image Manifest Version 2, Schema 1

```
{
   "schemaVersion": 1,
   "name": "my-ubuntu",
   "tag": "latest",
   "architecture": "amd64",
   "fsLayers": [
      {
         "blobSum": "sha256:fc0342a94c89e477c821328ccb542e6fb86ce4ef4ebbf1098e85669e051ef0dd"
      },
      {
         "blobSum": "sha256:9f15a39356d6fc1df0a77012bf1aa2150b683e46be39d1c51bc7a320f913e322"
      },
      {
         "blobSum": "sha256:275abb2c8a6f1ce8e67a388a11f3cc014e98b36ff993a6ed1cc7cd6ecb4dd61b"
      },
      {
         "blobSum": "sha256:f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f"
      },
      {
         "blobSum": "sha256:50aff78429b146489e8a6cb9334d93a6d81d5de2edc4fbf5e2d4d9253625753e"
      }
   ],
   "history": [
      {
         "v1Compatibility": "{\"architecture\":\"amd64\",\"config\":{\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/bash\"],\"ArgsEscaped\":true,\"Image\":\"sha256:34474a3a3cc6e7214fac71230369eb5178b5645acd8db7755c030037099b536a\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":null},\"container\":\"d512da9df07b186ea9bbad0424b1111fef17c10836ce9c5fdbf252544508803b\",\"container_config\":{\"Hostname\":\"d512da9df07b\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/sh\",\"-c\",\"#(nop) \",\"CMD [\\\"/bin/bash\\\"]\"],\"ArgsEscaped\":true,\"Image\":\"sha256:34474a3a3cc6e7214fac71230369eb5178b5645acd8db7755c030037099b536a\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":{}},\"created\":\"2017-12-14T20:59:48.244728969Z\",\"docker_version\":\"17.06.2-ce\",\"id\":\"c1ea3b5d13dd9eca42872a9787f51f6d09bbd2d56f364f231b1833d2fb08d04c\",\"os\":\"linux\",\"parent\":\"7d016c45d574ae04a42372f23ad8a8ce380d186c762fc9e1e2e6bad93fd54741\",\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"7d016c45d574ae04a42372f23ad8a8ce380d186c762fc9e1e2e6bad93fd54741\",\"parent\":\"6d26059fef3f9bbffe3231079b8a24996f9ff6b6373bbdfa635bb92a4e4294ad\",\"created\":\"2017-12-14T20:59:48.062144391Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c mkdir -p /run/systemd \\u0026\\u0026 echo 'docker' \\u003e /run/systemd/container\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"6d26059fef3f9bbffe3231079b8a24996f9ff6b6373bbdfa635bb92a4e4294ad\",\"parent\":\"43ea2a37afe784b6f64b2f86aedacfe3b37d7295f31c5c61a7a75b8fd2eec74b\",\"created\":\"2017-12-14T20:59:47.411048575Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c sed -i 's/^#\\\\s*\\\\(deb.*universe\\\\)$/\\\\1/g' /etc/apt/sources.list\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"43ea2a37afe784b6f64b2f86aedacfe3b37d7295f31c5c61a7a75b8fd2eec74b\",\"parent\":\"c4cc29c71ec176e64c42194057c46d2ef4f6907f2665069bd75c07d51766582e\",\"created\":\"2017-12-14T20:59:46.735863349Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c rm -rf /var/lib/apt/lists/*\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"c4cc29c71ec176e64c42194057c46d2ef4f6907f2665069bd75c07d51766582e\",\"parent\":\"d4bcfe3fb921825ac69184ce2dc1d4e56f49f6584e82d8b8d8e6b1b81be689be\",\"created\":\"2017-12-14T20:59:46.089739785Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c set -xe \\t\\t\\u0026\\u0026 echo '#!/bin/sh' \\u003e /usr/sbin/policy-rc.d \\t\\u0026\\u0026 echo 'exit 101' \\u003e\\u003e /usr/sbin/policy-rc.d \\t\\u0026\\u0026 chmod +x /usr/sbin/policy-rc.d \\t\\t\\u0026\\u0026 dpkg-divert --local --rename --add /sbin/initctl \\t\\u0026\\u0026 cp -a /usr/sbin/policy-rc.d /sbin/initctl \\t\\u0026\\u0026 sed -i 's/^exit.*/exit 0/' /sbin/initctl \\t\\t\\u0026\\u0026 echo 'force-unsafe-io' \\u003e /etc/dpkg/dpkg.cfg.d/docker-apt-speedup \\t\\t\\u0026\\u0026 echo 'DPkg::Post-Invoke { \\\"rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\\\"; };' \\u003e /etc/apt/apt.conf.d/docker-clean \\t\\u0026\\u0026 echo 'APT::Update::Post-Invoke { \\\"rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\\\"; };' \\u003e\\u003e /etc/apt/apt.conf.d/docker-clean \\t\\u0026\\u0026 echo 'Dir::Cache::pkgcache \\\"\\\"; Dir::Cache::srcpkgcache \\\"\\\";' \\u003e\\u003e /etc/apt/apt.conf.d/docker-clean \\t\\t\\u0026\\u0026 echo 'Acquire::Languages \\\"none\\\";' \\u003e /etc/apt/apt.conf.d/docker-no-languages \\t\\t\\u0026\\u0026 echo 'Acquire::GzipIndexes \\\"true\\\"; Acquire::CompressionTypes::Order:: \\\"gz\\\";' \\u003e /etc/apt/apt.conf.d/docker-gzip-indexes \\t\\t\\u0026\\u0026 echo 'Apt::AutoRemove::SuggestsImportant \\\"false\\\";' \\u003e /etc/apt/apt.conf.d/docker-autoremove-suggests\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"d4bcfe3fb921825ac69184ce2dc1d4e56f49f6584e82d8b8d8e6b1b81be689be\",\"created\":\"2017-12-14T20:59:45.307546564Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) ADD file:f5a2d04c3f3cafada15eb32e4e8d971e48ef11724939c399a8664bf498111e67 in / \"]}}"
      }
   ],
   "signatures": [
      {
         "header": {
            "jwk": {
               "crv": "P-256",
               "kid": "R5SQ:AFOK:5PGB:CRKQ:PN6T:3S5K:6MJS:EHNY:NNV5:3PEZ:B5SA:S7AW",
               "kty": "EC",
               "x": "w3jy1n61gifPk6O-QWB-Q1sHJ12nWA8W6jjLYrlNcaQ",
               "y": "uLAu6xnS9JpvVDX8iOC_4N4aiYrseKu6HaTEBH7m-5s"
            },
            "alg": "ES256"
         },
         "signature": "zUTSLR-9x73czupXu2nEZxjXChIJ4MfwadgYSg01j-hZ_9FAFXeEDGy7DlsLb49Ev5SNJAK66VBcxAwm7nKefw",
         "protected": "eyJmb3JtYXRMZW5ndGgiOjU0MDIsImZvcm1hdFRhaWwiOiJDbjAiLCJ0aW1lIjoiMjAxOC0wMS0xMlQwMzowNjowMVoifQ"
      }
   ]
}
```

* Image Manifest Version 2, Schema 2

```javascript
{
schemaVersion: 2,
mediaType: "application/vnd.docker.distribution.manifest.v2+json",
config: {
mediaType: "application/vnd.docker.container.image.v1+json",
size: 3615,
digest: "sha256:00fd29ccc6f167fa991580690a00e844664cb2381c74cd14d539e36ca014f043" IMAGE ID config
},
layers: [
{
mediaType: "application/vnd.docker.image.rootfs.diff.tar.gzip",
size: 42743207,
digest: "sha256:50aff78429b146489e8a6cb9334d93a6d81d5de2edc4fbf5e2d4d9253625753e"
},
{
mediaType: "application/vnd.docker.image.rootfs.diff.tar.gzip",
size: 846,
digest: "sha256:f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f"
},
{
mediaType: "application/vnd.docker.image.rootfs.diff.tar.gzip",
size: 621,
digest: "sha256:275abb2c8a6f1ce8e67a388a11f3cc014e98b36ff993a6ed1cc7cd6ecb4dd61b"
},
{
mediaType: "application/vnd.docker.image.rootfs.diff.tar.gzip",
size: 854,
digest: "sha256:9f15a39356d6fc1df0a77012bf1aa2150b683e46be39d1c51bc7a320f913e322"
},
{
mediaType: "application/vnd.docker.image.rootfs.diff.tar.gzip",
size: 170,
digest: "sha256:fc0342a94c89e477c821328ccb542e6fb86ce4ef4ebbf1098e85669e051ef0dd"
}
]
}
```

### Pulling a Layer

`GET /v2/<name>/blobs/<digest>` digest 要加上`sha256:`

```
curl -I -X GET http://127.0.0.1:5000/v2/my-ubuntu/blobs/sha256:f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f
HTTP/1.1 200 OK
Accept-Ranges: bytes
Cache-Control: max-age=31536000
Content-Length: 846
Content-Type: application/octet-stream
Docker-Content-Digest: sha256:f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:f6d82e297bce031a3de1fa8c1587535e34579abce09a61e37f5a225a8667422f"
Date: Fri, 19 Jan 2018 07:46:23 GMT
```

* 307?
* 要支持缓存协商
* 要支持ETag
* 考虑增加incremental下载
* 需要支持 Range

### Pushing An Image Layer


#### 启动上传

`POST /v2/<name>/blobs/uploads/` 末尾斜杠不能省

服务端会返回202 Accepted,  响应在 Location头信息中返回上传 URL

```
HTTP/1.1 202 Accepted
Content-Length: 0
Docker-Distribution-Api-Version: registry/2.0
Docker-Upload-Uuid: 626fd4d6-38db-48e3-ba73-45af0bfa5678
Location: http://127.0.0.1:5000/v2/foxtest/blobs/uploads/626fd4d6-38db-48e3-ba73-45af0bfa5678?_state=oE1NVRPEyI8JA-QS7az_At832y71v4-iPQ6rK9bGHVp7Ik5hbWUiOiJmb3h0ZXN0IiwiVVVJRCI6IjYyNmZkNGQ2LTM4ZGItNDhlMy1iYTczLTQ1YWYwYmZhNTY3OCIsIk9mZnNldCI6MCwiU3RhcnRlZEF0IjoiMjAxOC0wMS0xOVQwNzo1Njo1Ni40NDM4NTdaIn0%3D
Range: 0-0
Date: Fri, 19 Jan 2018 07:56:56 GMT
Content-Type: text/plain; charset=utf-8
```

如果客户端需要关联本地上传状态与远程上传状态，Docker-Upload-UUID头信息的内容应该被使用。这样的 id ，在实施可恢复的上传时，可以被用作最后用到的位置头信息的关键字


TODO `_state` 是啥

在服务端会生成:

```
└── repositories
    ├── foxtest
    │   └── _uploads
    │       └── 626fd4d6-38db-48e3-ba73-45af0bfa5678
    │           ├── data
    │           ├── hashstates
    │           │   └── sha256
    │           │       └── 0
    │           └── startedat
```

#### 上传进度检查

`GET /v2/<name>/blobs/uploads/<uuid>` 需要把上面返回的`_state`带上

```
curl -I -X GET http://127.0.0.1:5000/v2/foxtest/blobs/uploads/626fd4d6-38db-48e3-ba73-45af0bfa5678?_state=oE1NVRPEyI8JA-QS7az_At832y71v4-iPQ6rK9bGHVp7Ik5hbWUiOiJmb3h0ZXN0IiwiVVVJRCI6IjYyNmZkNGQ2LTM4ZGItNDhlMy1iYTczLTQ1YWYwYmZhNTY3OCIsIk9mZnNldCI6MCwiU3RhcnRlZEF0IjoiMjAxOC0wMS0xOVQwNzo1Njo1Ni40NDM4NTdaIn0%3D
HTTP/1.1 204 No Content
Docker-Distribution-Api-Version: registry/2.0
Docker-Upload-Uuid: 626fd4d6-38db-48e3-ba73-45af0bfa5678
Location: http://127.0.0.1:5000/v2/foxtest/blobs/uploads/626fd4d6-38db-48e3-ba73-45af0bfa5678?_state=ISOcuCMWgI9dncvUZ58evhe3JvOW9dd_Wcuam7Ps6xF7Ik5hbWUiOiJmb3h0ZXN0IiwiVVVJRCI6IjYyNmZkNGQ2LTM4ZGItNDhlMy1iYTczLTQ1YWYwYmZhNTY3OCIsIk9mZnNldCI6MCwiU3RhcnRlZEF0IjoiMjAxOC0wMS0xOVQwNzo1Njo1NloifQ%3D%3D
Range: 0-0
Date: Fri, 19 Jan 2018 08:09:59 GMT
```

#### 存在性检测

`HEAD /v2/<name>/blobs/<digest>`

#### 整体上传（Monolithic Upload
#### 块上传(Chunked Upload)
#### 完整的上传(Completed Upload)


#### 取消上传(Canceling an Upload)

`DELETE /v2/<name>/blobs/uploads/<uuid>`

该请求发送后，相关上传的 uuid 会失效，并且 registry 服务器会删除所有相关数据。在上传没有完成并要超时的情况下，如果遇到一个致命错误但仍有发送 http 请求的能力，客户端会发出这个请求

---

## HTTPS

https://www.cnblogs.com/xcloudbiz/articles/5526262.html

* Insecure Registry: 接收plain http访问的Registry.

  需要客户端的Docker daemon上配置: `DOCKER_OPTS="--insecure-registry 10.10.105.71:5000 ....`

* Secure Registry: transport采用tls, 需要为Registry配置tls所需的key和crt文件

  ```
  $ docker run -d -p 5000:5000 --restart=always --name registry \
  -v `pwd`/data:/var/lib/registry \
  -v `pwd`/certs:/certs \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \ 证书
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \         私钥
  registry:2
  ```

---

## 认证

认证相关的配置: <https://github.com/docker/distribution/blob/master/docs/configuration.md>

其中token的配置:

* realm: 描述了认证的enpoint, 如`realm="https://registry.example.com:5001/auth"`
* service: `描述了持有资源服务器的名称` 应该表示registry自己
* issuer: token发布者, 发布者会把这个插入token, 所有registry需要设置一样的
* rootcertbundle: 证书绝对地址, 用于解开token

也可以使用环境变量如: `REGISTRY_AUTH_TOKEN_REALM` `REGISTRY_AUTH_TOKEN_SERVICE`


以docker-compose为例

```
registry:
  ports:
    - 5000:5000/tcp
  image: registry:2
  volumes:
    - "./certs:/certs:ro"
    - "./registry/storage:/var/lib/registry:rw"
  environment:
    - REGISTRY_AUTH=token
    - REGISTRY_AUTH_TOKEN_REALM=http://172.16.137.217:8080/auth
    - REGISTRY_AUTH_TOKEN_SERVICE="Docker registry"
    - REGISTRY_AUTH_TOKEN_ISSUER="Auth Service"
    - REGISTRY_HTTP_SECRET=secretkey
    - REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE=/certs/auth.crt
    - REGISTRY_LOG_LEVEL=debug
```

认证过程参考: <http://dockone.io/article/845> <http://yunlzheng.github.io/2016/11/29/docker-registry-details/>

1. docker client 尝试到registry中进行push/pull操作
2. registry会返回401未认证信息给client(未认证的前提下)，同时返回的信息中还包含了到哪里去认证的信息

   ```
   HTTP/1.1 401 Unauthorized
   Server: nginx/1.4.7
   Date: Sun, 22 Nov 2015 09:01:42 GMT
   Content-Type: application/json; charset=utf-8
   Content-Length: 87
   Connection: keep-alive
   Docker-Distribution-Api-Version: registry/2.0
   Www-Authenticate: Bearer realm="http://172.16.137.217:8080/auth",service="Docker registry",scope="repository:samalba/my-app:pull,push"
   X-Content-Type-Options: nosniff
   ```

   其中:realm, service 同registry的配置

   scope: 描述了client端操作资源的方法(push/pull) `scope="repository:shuyun/hello:push"`

   account: 描述了操作的账号 `account=admin`

3. client发送认证请求到认证服务器(authorization service)

   Docker Client提供用户输入用户名和密码后向auth server的Endpoint发送请求：`http://172.16.137.217:8080/auth?service=Docker registry&scope=repository:samalba/my-app:pull,push`

   同时在http head中包含用户相关的登录信息: `authorized: Basic YWtaW46cGzc3dvmcQ=`

4. 认证服务器(authorization service)返回token

   基于JWT协议规范使用私钥对返回内容签名生成相应的Token:

   ```
   HTTP/1.1 200 OK
   Content-Type: application/json

   {"token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6IlBZWU86VEVXVTpWN0pIOjI2SlY6QVFUWjpMSkMzOlNYVko6WEdIQTozNEYyOjJMQVE6WlJNSzpaN1E2In0.eyJpc3MiOiJhdXRoLmRvY2tlci5jb20iLCJzdWIiOiJqbGhhd24iLCJhdWQiOiJyZWdpc3RyeS5kb2NrZXIuY29tIiwiZXhwIjoxNDE1Mzg3MzE1LCJuYmYiOjE0MTUzODcwMTUsImlhdCI6MTQxNTM4NzAxNSwianRpIjoidFlKQ08xYzZjbnl5N2tBbjBjN3JLUGdiVjFIMWJGd3MiLCJhY2Nlc3MiOlt7InR5cGUiOiJyZXBvc2l0b3J5IiwibmFtZSI6InNhbWFsYmEvbXktYXBwIiwiYWN0aW9ucyI6WyJwdXNoIl19XX0.QhflHPfbd6eVF4lM9bwYpFZIV0PfikbyXuLx959ykRTBpe3CYnzs6YBK8FToVb5R47920PVLrh8zuLzdCr9t3w", "expires_in": 3600,"issued_at": "2009-11-10T23:00:00Z"}
   ```

5. client携带这附有token的请求，尝试请求registry

  `Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6IkJWM0Q6MkFWWjpVQjVaOktJQVA6SU5QTDo1RU42Ok40SjQ6Nk1XTzpEUktFOkJWUUs6M0ZKTDpQT1RMIn0.eyJpc3MiOiJhdXRoLmRvY2tlci5jb20iLCJzdWIiOiJCQ0NZOk9VNlo6UUVKNTpXTjJDOjJBVkM6WTdZRDpBM0xZOjQ1VVc6NE9HRDpLQUxMOkNOSjU6NUlVTCIsImF1ZCI6InJlZ2lzdHJ5LmRvY2tlci5jb20iLCJleHAiOjE0MTUzODczMTUsIm5iZiI6MTQxNTM4NzAxNSwiaWF0IjoxNDE1Mzg3MDE1LCJqdGkiOiJ0WUpDTzFjNmNueXk3a0FuMGM3cktQZ2JWMUgxYkZ3cyIsInNjb3BlIjoiamxoYXduOnJlcG9zaXRvcnk6c2FtYWxiYS9teS1hcHA6cHVzaCxwdWxsIGpsaGF3bjpuYW1lc3BhY2U6c2FtYWxiYTpwdWxsIn0.Y3zZSwaZPqy4y9oRBVRImZyv3m_S9XDHF1tWwN7mL52C_IiA73SJkWVNsvNqpJIn5h7A2F8biv_S2ppQ1lgkbw`

6. registry接受了认证的token并且使得client继续操作


### JWK

#### 头部（Header）

```
{
    "typ": "JWT", 当使用JWT时，typ固定为“JWT”
    "alg": "ES256", 签名算法
    "kid": "PYYO:TEWU:V7JH:26JV:AQTZ:LJC3:SXVJ:XGHA:34F2:2LAQ:ZRMK:Z7Q6" 和公钥相关, TODO
}
```

进行Base64编码，之后的字符串就成了JWT的Header（头部）

#### 载荷（Payload）

```
{
    "iss": "Auth Service", 该JWT的签发者 //需要注意必须与auth.token.issuer配置保持一致
    "sub": "some id", 该JWT所面向的用户 //根据业务系统的规则自定义生成即可
    "aud": "Docker registry", 接收该JWT的一方 // 从请求的service参数获取
    "exp": 1415387315, //过期时间
    "nbf": 1415387015, // not before 可选参数
    "iat": 1415387015, // 正式发行时间
    "jti": "tYJCO1c6cnyy7kAn0c7rKPgbV1H1bFws", //随机生成即可
    // access根据请求的scope获取，当然业务系统要判断用户的实际权限并在actions中放回
    "access": [
        {
            "type": "repository",
            "name": "samalba/my-app",
            "actions": [
                "pull",
                "push"
            ]
        }
    ]

}
```

将上面的JSON对象进行[base64编码]可以得到下面的字符串。这个字符串我们将它称作JWT的Payload

#### 签名（签名）

```
RSASHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  'auth.key file content  也就是秘钥'
)
```

最后把以上三个结果再次通过点号join在一起, 就是完整的JWT

----

## Docker 本地存储

* 默认存储路径: `/var/lib/docker`

* layer.DiffID: SHA256hex(uncompressed layer tar data)

* layer.ChainID:
  For bottom layer: ChainID(layer0) = DiffID(layer0)
  For other layers: ChainID(layerN) = SHA256hex(ChainID(layerN-1) + " " + DiffID(layerN))

* image.ID: SHA256hex(imageConfigJSON)

```
$ sudo tree . -L 3
.
├── aufs
│   ├── diff
│   │   ├── 024f2af668a25bd0efcb3c1ae53c95f780fe7f84a5f7652fc3603aa1daa284d2
│   │   ├── 166d40dc45b1ff354282429d32117c98b025d8713de7be5dab7150eb98d4ce74
│   │   ├── 67a2f06df297d09211a3349245d987bb3020f5c08697b1021e9a825ea9f1e304-init
│   │   ├── 68f9cf205ca7aed2b2b82f50ae4c321aaa0ddb517d0d642d171a23d8b99a5c76
│   │   ├── 73fdbb31d7fca4c78d41836ecb48fd07ba8737b83115c4c32f95d6090097456b-init
│   │   ├── 80ba70a43d4b02b02456907c686ff0add12fcb567d6fa4c5ad673e492a5975f8
│   ├── layers
│   │   ├── 67a2f06df297d09211a3349245d987bb3020f5c08697b1021e9a825ea9f1e304
│   │   ├── 67a2f06df297d09211a3349245d987bb3020f5c08697b1021e9a825ea9f1e304-init
│   │   ├── 73fdbb31d7fca4c78d41836ecb48fd07ba8737b83115c4c32f95d6090097456b
│   │   ├── 73fdbb31d7fca4c78d41836ecb48fd07ba8737b83115c4c32f95d6090097456b-init
│   │   ├── 81463e36170507752ec2225985604f9c4d506791b8783c85c24a9668b018c00d
│   │   ├── a5c23ffc07999599f2f94109c618ea797b9d4b8f2af6807ee5406df4ebf72993-init
│   │   └── fa04c9d948b44505cd0bdc0eb9087f0ca4e91e8856d49e90d56428c4848899b0
│   └── mnt
│       ├── 80ba70a43d4b02b02456907c686ff0add12fcb567d6fa4c5ad673e492a5975f8-init
│       ├── a5c23ffc07999599f2f94109c618ea797b9d4b8f2af6807ee5406df4ebf72993
│       ├── ae13e9bbfcf13653047c7e61a14bf5563b7cbb07f68c4dc23bfa5f663993abe2-init
│       └── fa04c9d948b44505cd0bdc0eb9087f0ca4e91e8856d49e90d56428c4848899b0
├── builder
├── containerd
│   └── daemon
├── containers
│   ├── 3231802a57b6af43c3bb54eb4a67d473afcb62705beb4c19a5fcf98302aa6809
│   │   ├── 3231802a57b6af43c3bb54eb4a67d473afcb62705beb4c19a5fcf98302aa6809-json.log
│   │   ├── checkpoints
│   │   ├── config.v2.json
│   │   ├── hostconfig.json
│   │   ├── hostname
│   │   ├── hosts
│   │   ├── resolv.conf
│   │   ├── resolv.conf.hash
│   │   └── shm
│   └── f8a122aedda035c4f100d02e66c3be9264f0284a63cee8f829b2026514506b35
├── image
│   └── aufs
│       ├── distribution 
          ├── diffid-by-digest 保存了digest->diffid的映射关系，即distribution hashes和Content hashes的映射关系。这可以方便检查layer是否在本地已经存在
          │   └── sha256
          │       ├── e872a2642ce1d63f3283e81bb6503579808c01e2bf63412ef87135ecb0f04746 文件名是distribution hashes, 内容是Content hashes TODO 验证
          │       └── ef25ef6e9e7be10e07503c12c0309580d77eaffe56ab4376bda13eea5f1a5493
          └── v2metadata-by-diffid 保存了diffid -> (digest,repository)的映射关系，这可以方便查找layer的digest及其所属的repository
              └── sha256
                  ├── 833649a3e04c96faf218d8082b3533fa0674664f4b361c93cad91cf97222b733 内容 [{"Digest":"sha256:c0a04912aa5afc0...","SourceRepository":"10.x.x.x:5000/busybox"}]
                  └── 8600ee70176b569d0776833f106d239d56043cb854a5edbb74aff6c5e8d4782d
        ├── imagedb 保存image的信息
        │   ├── content
        │   │   └── sha256 镜像ID, 下面文件都是json, 内容是镜像元数据配置, 用于算出imageID
        │   │       ├── 2a4cca5ac898476c2c47a8d6a17102e00241d6fa377fbe4d50787fe3d7a8d4d6
        │   │       └── f2a91732366c0332ccd7afd2a5c4ff2b9af81f549370f7a19acd460f87686bc7
        │   └── metadata
        │       └── sha256
│       ├── layerdb 保存layer的信息
          ├── mounts TODO
          │   ├── 3231802a57b6af43c3bb54eb4a67d473afcb62705beb4c19a5fcf98302aa6809
          │   │   ├── init-id
          │   │   ├── mount-id
          │   │   └── parent
          │   ├── 8b083d2fe47013176290c201bdce02135616ef5bcce52c4984132b94c3bea646
          │   │   ├── init-id
          │   │   ├── mount-id
          │   │   └── parent
          ├── sha256 目录名称为layer的chainID
          │   ├── 01c7acde7bc52fac47440a98e8a92994d337d7e55037dd903c9cf56ad22e2f81
          │   │   ├── cache-id
          │   │   ├── diff 保存当前layer的diff ID
          │   │   ├── parent 保存上一层layer的chainID
          │   │   ├── size
          │   │   └── tar-split.json.gz
          │   └── 1599365ecbaf5b106d874fcbce0a70283e3ecff771f0f826c7695fd85c2f7eaa
          │       ├── cache-id
          │       ├── diff
          │       ├── parent
          │       ├── size
          │       └── tar-split.json.gz
          └── tmp
│       └── repositories.json 镜像元数据, 包括镜像名, tag和 ImageID的对应关系
├── network
├── plugins
├── runtimes
├── swarm
├── tmp
├── trust
└── volumes
    └── metadata.db
```


----


参考: <http://hustcat.github.io/docker-image-new-format/>


---


## TODO 临时笔记 移走

####  MIME Type

资源的媒体类型, 由 Web 服务器告知浏览器的，更准确地说，是通过 Content-Type 来表示的, 浏览器区分它们，决定什么内容用什么形式来显示.

通常只有一些在互联网上获得广泛应用的格式才会获得一个 MIME Type，如果是某个客户端自己定义的格式，一般只能以 application/x- 开头

#### Http报头

* 通用报头
* 请求报头
* 响应报头
* 实体报头

请求方的http报头结构：通用报头|请求报头|实体报头
响应方的http报头结构：通用报头|响应报头|实体报头


*  Accept header: 属于请求头. 代表发送端（客户端）希望接受的数据类型.

*  Content-Type: 属于实体头, 客户端和服务器端都可以发送, 客户端用此表示上传的实体类型, 如POST/PUT, 服务器端用此表示返回的实体类型.

  对于HTML form submission, 通常的response Content-Type:

  * application/x-www-form-urlencoded (default, older, simpler, slightly less overhead for small amounts of simple ASCII text, no file upload support)
  * multipart/form-data (newer, adds support for file uploads, more efficient for large amounts of binary data or non-ASCII text)


参考:

<https://webmasters.stackexchange.com/questions/31212/difference-between-the-accept-and-content-type-http-headers>

<http://www.w3school.com.cn/media/media_mimeref.asp>
