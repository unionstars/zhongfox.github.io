---
layout: post
tags : [linux]
title: Linux 性能优化笔记

---


## 平均负载

```
% uptime
10:38  up 3 days, 21:19, 8 users, load averages: 2.69 2.74 2.93
```

最后三个数字呢，依次则是过去 1 分钟、5 分钟、15 分钟的平均负载（Load Average）

* 平均负载: 是指单位时间内，系统处于**可运行**状态和**不可中断**状态的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系，它不仅包括了正在使用 CPU 的进程，还包括等待 CPU 和等待 I/O 的进程

* 可运行状态: 是指正在使用 CPU 或者正在等待 CPU 的进程，也就是我们常用 ps 命令看到的，处于 R 状态（Running 或 Runnable）的进程
* 不可中断状态: 是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是我们在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程, 不可中断状态实际上是系统对进程和硬件设备的一种保护机制.

平均负载最理想的情况是等于 CPU 个数

----

## CPU 的上下文切换

上下文切换的场景:

* 进程上下文切换:

  从一个进程切换到另一个进程运行

  进程是由内核来管理和调度的，进程的切换只能发生在内核态

  包括了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的状态

* 线程上下文切换

  线程也有自己的私有数据，比如栈和寄存器等，这些在上下文切换时也是需要保存的

  同进程中的线程切换: 虚拟内存是共享的，所以在切换时，虚拟内存这些资源就保持不动，只需要切换线程的私有数据、寄存器等不共享的数据

* 中断上下文切换

* 特权模式切换:

  同一个进程在运行中进行系统调用过程

  一次系统调用的过程，其实是发生了两次 CPU 上下文切换


进程上下文切换的可能原因:

* 时间片耗尽
* 进程在系统资源不足（比如内存不足）时，要等到资源满足后才可以运行，这个时候进程也会被挂起，并由系统调度其他进程运行
* 睡眠函数 sleep
* 为了保证高优先级进程的运行，当前进程会被挂起，由高优先级进程来运行
* 硬件中断时，CPU 上的进程会被中断挂起，转而执行内核中的中断服务程序


进程上下文切换类型:

* 自愿上下文切换: 是指进程无法获取所需资源，导致的上下文切换
* 非自愿上下文切换: 则是指进程由于时间片已到等原因，被系统强制调度，进而发生的上下文切换。比如说，大量进程都在争抢 CPU 时，就容易发生非自愿上下文切换



---

## 工具

### stress

 Linux 系统压力测试工具

### mpstat

多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，以及所有 CPU 的平均指标

### pidstat

进程性能分析工具，用来实时查看进程的 CPU、内存、I/O 以及上下文切换等性能指标

### vmstat

系统的内存使用情况，也常用来分析 CPU 上下文切换和中断的次数
